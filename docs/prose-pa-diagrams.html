<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<title>ProSe-PA v0.78 ‚Äî Architecture & Logigrammes</title>
<script src="https://cdn.jsdelivr.net/npm/mermaid@10/dist/mermaid.min.js"></script>
<style>
  * { margin: 0; padding: 0; box-sizing: border-box; }
  body { font-family: 'Segoe UI', system-ui, sans-serif; background: #f5f6fa; color: #2d3436; padding: 2rem; }
  h1 { font-size: 1.8rem; margin-bottom: 0.3rem; color: #0a3d62; }
  h2 { font-size: 1.35rem; margin: 2.5rem 0 0.8rem; color: #1e3799; border-bottom: 2px solid #dfe6e9; padding-bottom: 0.3rem; }
  h3 { font-size: 1.05rem; margin: 1.5rem 0 0.5rem; color: #474787; }
  p, li { font-size: 0.92rem; line-height: 1.55; }
  .subtitle { color: #636e72; font-size: 0.95rem; margin-bottom: 2rem; }
  .diagram-container { background: #fff; border-radius: 8px; padding: 1.5rem; margin: 1rem 0; box-shadow: 0 2px 8px rgba(0,0,0,0.06); overflow-x: auto; }
  .diagram-container .mermaid { display: flex; justify-content: center; }
  .legend { background: #dfe6e9; border-radius: 6px; padding: 0.8rem 1.2rem; margin: 0.8rem 0; font-size: 0.85rem; }
  .legend span { display: inline-block; width: 14px; height: 14px; border-radius: 3px; vertical-align: middle; margin-right: 5px; }
  .legend .c-hyd { background: #74b9ff; }
  .legend .c-ttc { background: #a29bfe; }
  .legend .c-rive { background: #55efc4; }
  .legend .c-seb { background: #ffeaa7; }
  .legend .c-da { background: #fab1a0; }
  .legend .c-io { background: #b2bec3; }
  table { border-collapse: collapse; margin: 0.8rem 0; font-size: 0.88rem; width: 100%; }
  th, td { border: 1px solid #dfe6e9; padding: 6px 10px; text-align: left; }
  th { background: #0a3d62; color: #fff; }
  tr:nth-child(even) { background: #f1f2f6; }
  code { background: #dfe6e9; padding: 1px 5px; border-radius: 3px; font-size: 0.88em; }
  @media print { body { padding: 0.5cm; } .diagram-container { box-shadow: none; border: 1px solid #ccc; } }
</style>
</head>
<body>

<h1>ProSe-PA v0.78 ‚Äî Architecture & Logigrammes</h1>
<p class="subtitle">Mod√®le hydro-biog√©ochimique 1D pour rivi√®res urbanis√©es ‚Äî Mines Paris / Geosciences</p>

<!-- ============================================================ -->
<h2>1. Architecture g√©n√©rale</h2>
<!-- ============================================================ -->

<div class="diagram-container">
<pre class="mermaid">
graph TB
    subgraph INPUTS["üì• FICHIERS D'ENTR√âE"]
        CMD["Fichier de commande<br/><i>.comm</i>"]
        GEOM["G√©om√©trie r√©seau<br/><i>sections, biefs, profils</i>"]
        HYDRO_IN["Conditions aux limites hydro<br/><i>Q(t), Z(t) aval</i>"]
        BIO_IN["Conditions aux limites bio<br/><i>concentrations apports</i>"]
        METEO["Donn√©es m√©t√©o / SAFRAN<br/><i>T_air, Rg, Rh, Vent, P</i>"]
        OBS["Observations HF O‚ÇÇ<br/><i>s√©ries temporelles</i>"]
        INIT["Conditions initiales<br/><i>C‚ÇÄ, T‚ÇÄ, √©tat final ant√©rieur</i>"]
    end

    subgraph CORE["‚öôÔ∏è PROSE-PA (main_PROSE.c)"]
        direction TB
        PARSER["Parser Bison/Flex<br/><i>input.y / lexical.l</i>"]
        SIMUL["Structure Simul<br/><code>s_simul_PROSE</code>"]
        MODES{{"R√©gime ?"}}
        STEADY["R√©gime permanent"]
        TRANSIENT["R√©gime transitoire"]
    end

    subgraph LIBS["üìö 12 BIBLIOTH√àQUES"]
        direction TB
        subgraph UTIL["Utilitaires"]
            LP["libprint 1.24<br/><i>affichage, logs</i>"]
            TS["libts 1.74<br/><i>s√©ries temporelles</i>"]
            PC["libpc 0.05<br/><i>parall√©lisme OMP</i>"]
            GC["libgc 0.13<br/><i>solveur gradient conjugu√©</i>"]
            IO["libio 0.21<br/><i>gestion I/O fichiers</i>"]
            CHR["libchronos 0.13<br/><i>gestion temporelle</i>"]
            MB["libmb 0.01<br/><i>bilans de masse</i>"]
        end
        subgraph PHYS["Physique"]
            HYD["libhyd 0.44<br/><i>hydraulique 1D / pseudo-2D</i>"]
            TTC["libttc 0.13<br/><i>transport advection-dispersion</i>"]
            SEB["libseb 0.09<br/><i>bilan √©nerg√©tique surface</i>"]
            TUB["libtube 0.08<br/><i>tubes de courant navigation</i>"]
        end
        subgraph BIO["Biog√©ochimie"]
            RIVE["c-rive 0.37<br/><i>mod√®le RIVE (C, O, N, P, Si)</i>"]
        end
    end

    subgraph OUTPUTS["üì§ FICHIERS DE SORTIE"]
        HYD_OUT["Sorties hydrauliques<br/><i>Q, H, V par bief</i>"]
        BIO_OUT["Sorties biog√©ochimiques<br/><i>concentrations par esp√®ce</i>"]
        TEMP_OUT["Sorties thermiques<br/><i>T(x,t)</i>"]
        MB_OUT["Bilans de masse<br/><i>par esp√®ce, par domaine</i>"]
        DA_OUT["Sorties assimilation<br/><i>poids, param√®tres, Neff</i>"]
        TUBE_OUT["Sorties tubes navigation<br/><i>maillage, hydro tubes</i>"]
        DEBUG["Fichier debug<br/><i>argv[2]</i>"]
        EB_OUT["Bilan √©nerg√©tique<br/><i>flux atmosph√©riques</i>"]
    end

    CMD --> PARSER
    GEOM --> PARSER
    HYDRO_IN --> PARSER
    BIO_IN --> PARSER
    METEO --> PARSER
    OBS --> PARSER
    INIT --> PARSER
    PARSER --> SIMUL
    SIMUL --> MODES
    MODES -->|STEADY| STEADY
    MODES -->|TRANSIENT| TRANSIENT

    STEADY --> LIBS
    TRANSIENT --> LIBS
    HYD --> TTC
    TTC --> RIVE
    SEB --> TTC
    GC --> TTC
    GC --> HYD
    CHR --> HYD
    TS --> HYD
    TS --> RIVE
    IO --> HYD

    LIBS --> HYD_OUT
    LIBS --> BIO_OUT
    LIBS --> TEMP_OUT
    LIBS --> MB_OUT
    LIBS --> DA_OUT
    LIBS --> TUBE_OUT
    LIBS --> DEBUG
    LIBS --> EB_OUT

    style INPUTS fill:#dfe6e9,stroke:#636e72
    style CORE fill:#ffeaa7,stroke:#fdcb6e
    style LIBS fill:#e8f5e9,stroke:#81c784
    style OUTPUTS fill:#e3f2fd,stroke:#64b5f6
    style UTIL fill:#f5f5f5,stroke:#b2bec3
    style PHYS fill:#e8eaf6,stroke:#7986cb
    style BIO fill:#e8f5e9,stroke:#66bb6a
</pre>
</div>

<div class="legend">
    <b>Couplage physique :</b>
    libhyd (Q,H,V) ‚Üí libttc (advection-dispersion C) ‚Üí c-rive (r√©actions biog√©ochimiques).
    libseb (flux atmosph√©riques) ‚Üí libttc (transport thermique T).
    Le solveur libgc (gradient conjugu√© / sparse) est partag√© entre hydraulique et transport.
</div>

<!-- ============================================================ -->
<h2>2. Modules activables (flags <code>calc_mode[]</code>)</h2>
<!-- ============================================================ -->

<table>
<tr><th>Flag</th><th>Module</th><th>Description</th><th>D√©pendances</th></tr>
<tr><td><code>HYD</code></td><td>Hydraulique</td><td>R√©solution Q, H, V ‚Äî Saint-Venant simplifi√© 1D</td><td>libhyd, libgc</td></tr>
<tr><td><code>TTC</code></td><td>Transport</td><td>Advection-dispersion des esp√®ces dissoutes et particulaires</td><td>libttc, libgc</td></tr>
<tr><td><code>RIVE</code></td><td>Biog√©ochimie</td><td>Mod√®le RIVE ‚Äî cycles C, O‚ÇÇ, N, P, Si dans colonne d'eau + benthos</td><td>c-rive</td></tr>
<tr><td><code>H_T</code></td><td>Thermique</td><td>Transport de la temp√©rature par advection-dispersion</td><td>libttc</td></tr>
<tr><td><code>SEB</code></td><td>Bilan √©nerg√©tique</td><td>√âchanges atmosph√®re/surface : Rg, Ra, convection, √©vaporation</td><td>libseb, donn√©es SAFRAN</td></tr>
<tr><td><code>TUB</code></td><td>Tubes de courant</td><td>G√©n√©ration des tubes de courant pour mod√©liser la navigation</td><td>libtube</td></tr>
<tr><td><code>DA</code></td><td>Assimilation</td><td>Filtre particulaire (PF) ou Ensemble Kalman Filter (EnKF)</td><td>N particules, observations O‚ÇÇ HF</td></tr>
<tr><td><code>MB_BIO</code></td><td>Bilan de masse bio</td><td>Calcul et sortie des bilans de masse par esp√®ce</td><td>libmb</td></tr>
<tr><td><code>EB_HEAT</code></td><td>Bilan √©nerg√©tique T</td><td>Bilan d'√©nergie d√©taill√© sur la temp√©rature</td><td>SEB requis</td></tr>
</table>

<!-- ============================================================ -->
<h2>3. Logigramme ‚Äî Mode Simulation Directe</h2>
<!-- ============================================================ -->

<h3>3.1 Phase d'initialisation (commune)</h3>

<div class="diagram-container">
<pre class="mermaid">
flowchart TD
    START(["<b>D√©marrage</b><br/>prose-pa CommandFile DebugFile"]) --> INIT_SIMUL["Cr√©er structure <code>Simul</code><br/><code>PROSE_init_simulation()</code>"]
    INIT_SIMUL --> PARSE["<b>Parser le fichier de commande</b><br/><code>lecture(argv[1])</code><br/>‚Üí Bison/Flex : input.y / lexical.l<br/>‚Üí Lecture g√©om√©trie, CL, params bio, m√©t√©o, DA"]
    PARSE --> HYD_INIT["<b>Init hydraulique</b><br/><code>HYD_initialize_hydro()</code><br/><code>HYD_assign_river()</code><br/><code>HYD_initialize_GC()</code>"]
    HYD_INIT --> CHECK_TTC{"Transport<br/>activ√© ?<br/><code>TTC=YES</code>"}

    CHECK_TTC -->|Oui| ALLOC_TTC["Allouer matrices transport<br/>sparse ou GC par esp√®ce"]
    CHECK_TTC -->|Non| CHECK_HT

    ALLOC_TTC --> CHECK_HT{"Thermique<br/>activ√© ?<br/><code>H_T=YES</code>"}
    CHECK_HT -->|Oui| INIT_TEMP["Init esp√®ce T¬∞<br/><code>PROSE_init_temp_specie()</code><br/><code>PROSE_init_heat_transport()</code>"]
    CHECK_HT -->|Non| CHECK_RIVE

    INIT_TEMP --> CHECK_SEB{"SEB activ√© ?"}
    CHECK_SEB -->|Oui| INIT_METEO["Charger donn√©es SAFRAN<br/>Lier cellules m√©t√©o ‚Üí √©l√©ments<br/><code>PROSE_link_icell_to_imet_SEB()</code><br/>Allouer flux de surface"]
    CHECK_SEB -->|Non| CHECK_RIVE
    INIT_METEO --> CHECK_RIVE

    CHECK_RIVE{"Biog√©ochimie<br/>activ√©e ?<br/><code>RIVE=YES</code>"}
    CHECK_RIVE -->|Oui| INIT_BIO["<b>Init RIVE par particule np</b><br/>‚Ä¢ <code>PROSE_init_reoxy_species()</code><br/>‚Ä¢ <code>PROSE_fill_param_base()</code><br/>‚Ä¢ <code>PROSE_alloc_u_dist()</code><br/>‚Ä¢ <code>PROSE_fill_neighbor()</code><br/>‚Ä¢ <code>PROSE_init_param_reaction()</code><br/>‚Ä¢ <code>PROSE_init_O2_conc_sat()</code><br/>‚Ä¢ Lier hydro‚Üîrive g√©om & hydro"]
    CHECK_RIVE -->|Non| CHECK_DA

    INIT_BIO --> CHECK_DA{"Assimilation<br/>activ√©e ?<br/><code>DA=YES</code>"}
    CHECK_DA -->|Oui| INIT_DA["Init assimilation<br/><code>Prose_init_assimilation()</code><br/><code>Prose_init_rand_param()</code><br/>Cr√©er fichiers poids/params"]
    CHECK_DA -->|Non| REGIME
    INIT_DA --> REGIME

    REGIME{{"<b>R√©gime hydraulique ?</b>"}}
    REGIME -->|STEADY| STEADY_MODE["‚ñ∂ Mode Permanent<br/><i>(voir ¬ß3.2)</i>"]
    REGIME -->|TRANSIENT| TRANSIENT_MODE["‚ñ∂ Mode Transitoire<br/><i>(voir ¬ß3.3)</i>"]

    style START fill:#0a3d62,color:#fff
    style PARSE fill:#ffeaa7,stroke:#fdcb6e
    style HYD_INIT fill:#74b9ff,stroke:#0984e3
    style ALLOC_TTC fill:#a29bfe,stroke:#6c5ce7
    style INIT_TEMP fill:#a29bfe,stroke:#6c5ce7
    style INIT_METEO fill:#ffeaa7,stroke:#f39c12
    style INIT_BIO fill:#55efc4,stroke:#00b894
    style INIT_DA fill:#fab1a0,stroke:#e17055
    style REGIME fill:#fd79a8,stroke:#e84393,color:#fff
</pre>
</div>

<h3>3.2 R√©gime permanent (STEADY)</h3>

<div class="diagram-container">
<pre class="mermaid">
flowchart TD
    S_START(["R√©gime STEADY"]) --> S_HYD["<b>Hydraulique permanente</b><br/><code>HYD_steady_state()</code><br/>‚Üí Q, H, V stationnaires"]
    S_HYD --> S_PRINT1["Imprimer sorties hydro + bio initiales"]

    S_HYD --> S_CHK_TUB{"TUB ?"}
    S_CHK_TUB -->|Oui| S_TUBE["Construire tubes de courant<br/><code>build_tube_domain_for_all_reaches()</code>"]
    S_CHK_TUB -->|Non| S_CHK_TTC

    S_TUBE --> S_CHK_TTC{"TTC + RIVE ?"}
    S_CHK_TTC -->|Oui| S_TRANSPORT["<b>Transport toutes esp√®ces</b><br/><code>PROSE_ttc_all_species()</code><br/>‚Üí R√©soudre advection-dispersion<br/>‚Üí Maj concentrations bio"]
    S_CHK_TTC -->|Non| S_CHK_HT

    S_TRANSPORT --> S_CHK_HT{"H_T ?"}
    S_CHK_HT -->|Oui| S_HEAT["<b>Transport thermique</b><br/>Maj m√©t√©o ‚Üí <code>PROSE_update_meteo_for_HT()</code><br/>R√©soudre T¬∞ ‚Üí <code>PROSE_ttc_one_species()</code><br/>It√©rer jusqu'√† convergence (Œµ)"]
    S_CHK_HT -->|Non| S_END

    S_HEAT --> S_PRINT_T["Imprimer sorties T¬∞"]
    S_PRINT_T --> S_END

    S_END(["FIN ‚Äî Impression bilan de masse final"])

    style S_START fill:#0a3d62,color:#fff
    style S_HYD fill:#74b9ff,stroke:#0984e3
    style S_TRANSPORT fill:#a29bfe,stroke:#6c5ce7
    style S_HEAT fill:#ffeaa7,stroke:#f39c12
    style S_END fill:#2d3436,color:#fff
</pre>
</div>

<h3>3.3 R√©gime transitoire (TRANSIENT) ‚Äî Simulation directe (<code>DA=NO</code>)</h3>

<div class="diagram-container">
<pre class="mermaid">
flowchart TD
    T_START(["R√©gime TRANSIENT"]) --> T_PRINT0["Imprimer conditions initiales<br/>t = t‚ÇÄ"]
    T_PRINT0 --> T_WHILE{"t ‚â§ t_end ?"}

    T_WHILE -->|Non| T_FIN(["FIN ‚Äî Bilan masse final<br/>√âtat final si demand√©"])
    T_WHILE -->|Oui| T_HYD

    T_HYD["<b>‚ë† HYDRAULIQUE</b><br/><code>HYD_transient_hydraulics()</code><br/>‚Üí R√©soudre Q(t), H(t), V(t)<br/>‚Üí t = t + dt"]

    T_HYD --> T_CHK_HT{"H_T ?"}
    T_CHK_HT -->|Oui| T_SEB_CHK{"SEB ?"}
    T_CHK_HT -->|Non| T_CHK_TTC

    T_SEB_CHK -->|Oui| T_SEB["<b>‚ë° BILAN √âNERG√âTIQUE</b><br/><code>PROSE_update_meteo_for_HT()</code><br/>‚Üí Calculer flux surface :<br/>Rg, Ra, H_conv, LE, H_cond"]
    T_SEB_CHK -->|Non| T_HEAT
    T_SEB --> T_HEAT

    T_HEAT["<b>‚ë¢ TRANSPORT THERMIQUE</b><br/><code>PROSE_update_heat_transport()</code><br/><code>PROSE_ttc_one_species_sparse()</code><br/>‚Üí R√©soudre T(x, t+dt)"]
    T_HEAT --> T_PRINT_T["Imprimer T(x,t)"]
    T_PRINT_T --> T_UPDATE_RIVE_T["Transf√©rer T ‚Üí RIVE<br/><i>tempe_value = T - T‚ÇÄ</i>"]
    T_UPDATE_RIVE_T --> T_CHK_TTC

    T_CHK_TTC{"TTC + RIVE ?"}
    T_CHK_TTC -->|Oui| T_TTC
    T_CHK_TTC -->|Non| T_CHK_RIVE2

    T_TTC["<b>‚ë£ TRANSPORT DES ESP√àCES</b><br/><i>‚àÄ np ‚àà [0, N_particules[</i><br/><code>PROSE_ttc_all_species()</code><br/>‚Üí Advection-dispersion<br/>   de chaque esp√®ce :<br/>   PHY, ZOO, BACT, O‚ÇÇ, NH‚ÇÑ,<br/>   NO‚ÇÉ, PO‚ÇÑ, MOD, etc.<br/><code>PROSE_update_phy_ctot()</code>"]
    T_TTC --> T_MB_CHK{"MB_BIO ?"}
    T_MB_CHK -->|Oui| T_MB["Bilan de masse transport<br/><code>PROSE_calc_mb_all_species()</code>"]
    T_MB_CHK -->|Non| T_CHK_RIVE2
    T_MB --> T_CHK_RIVE2

    T_CHK_RIVE2{"RIVE ?"}
    T_CHK_RIVE2 -->|Oui| T_RIVE
    T_CHK_RIVE2 -->|Non| T_OUTPUTS

    T_RIVE["<b>‚ë§ BIOG√âOCHIMIE RIVE</b><br/><i>‚àÄ np ‚àà [0, N_particules[</i><br/>‚Ä¢ Maj concentrations ‚Üê TTC<br/>‚Ä¢ Lier hydro ‚Üî rive<br/>‚Ä¢ Calculer volumes eau<br/>‚Ä¢ Interface eau/s√©diment<br/><code>PROSE_all_sections()</code><br/>‚Üí Cin√©tiques par section :<br/>   croissance/mortalit√© micro-org.<br/>   min√©ralisation MO<br/>   nitrification/d√©nitrification<br/>   production/respiration O‚ÇÇ<br/>   √©rosion/s√©dimentation"]

    T_RIVE --> T_MB_BIO{"MB_BIO ?"}
    T_MB_BIO -->|Oui| T_MB2["Bilan masse bio sections<br/>+ impression"]
    T_MB_BIO -->|Non| T_OUTPUTS
    T_MB2 --> T_OUTPUTS

    T_OUTPUTS["<b>‚ë• SORTIES</b><br/><code>PROSE_print_outputs_bio()</code><br/>Concentrations, hydro, T¬∞"]
    T_OUTPUTS --> T_WHILE

    style T_START fill:#0a3d62,color:#fff
    style T_FIN fill:#2d3436,color:#fff
    style T_HYD fill:#74b9ff,stroke:#0984e3
    style T_SEB fill:#ffeaa7,stroke:#f39c12
    style T_HEAT fill:#fdcb6e,stroke:#f39c12
    style T_TTC fill:#a29bfe,stroke:#6c5ce7
    style T_RIVE fill:#55efc4,stroke:#00b894
    style T_OUTPUTS fill:#b2bec3,stroke:#636e72
</pre>
</div>

<!-- ============================================================ -->
<h2>4. Logigramme ‚Äî Mode Assimilation de Donn√©es (<code>DA=YES</code>)</h2>
<!-- ============================================================ -->

<p>L'assimilation intervient <b>apr√®s</b> les √©tapes ‚ë£-‚ë§ (transport + RIVE) dans la boucle temporelle transitoire. Deux m√©thodes sont disponibles.</p>

<div class="diagram-container">
<pre class="mermaid">
flowchart TD
    DA_START(["Apr√®s RIVE ‚Äî DA activ√©"]) --> DA_METHOD{{"M√©thode ?"}}

    DA_METHOD -->|"<b>PF</b><br/>Filtre Particulaire"| PF_START
    DA_METHOD -->|"<b>EnKF</b><br/>Ensemble Kalman"| ENKF_START

    subgraph PF["FILTRE PARTICULAIRE (PF_PROSE)"]
        PF_START{"t = t_DA ?<br/><i>pas d'assimilation</i>"}
        PF_START -->|Non| PF_NO_OBS["Pas d'observation<br/>‚Üí Imprimer poids, params, conc.<br/>‚Üí <code>weights_prev = weights</code>"]
        PF_START -->|Oui| PF_DIFF["<b>Comparer obs vs simul</b><br/><code>Prose_calc_difference_obs_simul()</code><br/>‚Üí O‚ÇÇ mesur√© vs O‚ÇÇ simul√©<br/>par particule"]
        PF_DIFF --> PF_OBS_CHK{"Observations<br/>disponibles ?"}
        PF_OBS_CHK -->|Non| PF_NO_OBS
        PF_OBS_CHK -->|Oui| PF_WEIGHTS["<b>Calculer poids</b><br/><code>Prose_calc_weight_all_particules()</code><br/>vraisemblance ‚àù exp(-¬Ω (obs-sim)¬≤/œÉ¬≤)"]
        PF_WEIGHTS --> PF_NORM["<b>Normaliser poids + Neff</b><br/><code>Prose_calc_normalized_weights()</code><br/>Neff = 1 / Œ£w·µ¢¬≤"]
        PF_NORM --> PF_PRINT["Imprimer :<br/>‚Ä¢ Poids par particule<br/>‚Ä¢ Param√®tres extraits<br/>‚Ä¢ Concentrations<br/>‚Ä¢ Bilans de masse"]
        PF_PRINT --> PF_RESAMPLE{"Neff < Œ±¬∑N ?<br/><i>d√©g√©n√©rescence ?</i>"}
        PF_RESAMPLE -->|Oui| PF_DO_RESAMPLE["<b>R√©√©chantillonner</b><br/><code>Prose_fill_re_sample_elim_dupli()</code><br/><code>Prose_resample_particules()</code><br/>‚Üí Dupliquer les ¬´ bonnes ¬ª<br/>‚Üí √âliminer les ¬´ mauvaises ¬ª"]
        PF_DO_RESAMPLE --> PF_REINIT["R√©initialiser poids<br/><code>w·µ¢ = 1/N</code>"]
        PF_REINIT --> PF_PERTURB["<b>Perturber param√®tres</b><br/><code>Prose_perturbation_parameters()</code><br/>‚Üí Marche al√©atoire sur :<br/>  rm_phy, Œ±_phy, Pmax,<br/>  Œ∑_chla, Œº_bact, Y_bact,<br/>  mort_bact, Kreaeration, B1_river"]
        PF_PERTURB --> PF_NEW_W["Recalculer poids post-perturbation"]
        PF_RESAMPLE -->|Non| PF_RESET
        PF_NEW_W --> PF_RESET["<code>PROSE_reset_no_answer_obs()</code>"]
    end

    subgraph ENKF["ENSEMBLE KALMAN FILTER (ENKF_PROSE)"]
        ENKF_START["<b>EnKF</b><br/><code>Prose_processus_enkf()</code><br/>‚Üí Mise √† jour de l'ensemble<br/>   par correction Kalman :<br/>   x_a = x_f + K¬∑(y_obs - H¬∑x_f)<br/>   K = P_f¬∑H·µÄ¬∑(H¬∑P_f¬∑H·µÄ + R)‚Åª¬π"]
    end

    PF_NO_OBS --> DA_END
    PF_RESET --> DA_END
    ENKF_START --> DA_END

    DA_END(["Retour boucle temporelle"])

    style DA_START fill:#e17055,color:#fff
    style DA_END fill:#2d3436,color:#fff
    style PF fill:#ffecd2,stroke:#e17055
    style ENKF fill:#ffecd2,stroke:#e17055
    style PF_WEIGHTS fill:#fab1a0,stroke:#e17055
    style PF_DO_RESAMPLE fill:#ff7675,stroke:#d63031,color:#fff
    style PF_PERTURB fill:#fdcb6e,stroke:#f39c12
    style ENKF_START fill:#fab1a0,stroke:#e17055
</pre>
</div>

<h3>Param√®tres assimil√©s (13 max)</h3>
<table>
<tr><th>#</th><th>Param√®tre</th><th>Symbole</th><th>Module cible</th></tr>
<tr><td>0</td><td>Maintenance respiration PHY</td><td>rm_phy</td><td>RIVE</td></tr>
<tr><td>1</td><td>Coefficient Œ± PHY</td><td>Œ±_phy</td><td>RIVE</td></tr>
<tr><td>2</td><td>Taux max photosynth√®se</td><td>Pmax</td><td>RIVE</td></tr>
<tr><td>3</td><td>Ratio Chla/C PHY (Œ∑)</td><td>Œ∑_chla</td><td>RIVE</td></tr>
<tr><td>4</td><td>Concentration Chla PHY</td><td>C_chla</td><td>RIVE</td></tr>
<tr><td>5</td><td>Coeff extinction lumi√®re eau</td><td>Œ∑_water</td><td>RIVE</td></tr>
<tr><td>6</td><td>T¬∞ optimale PHY</td><td>Topt_phy</td><td>RIVE</td></tr>
<tr><td>7</td><td>Taux max croissance BACT</td><td>Œºmax_bact</td><td>RIVE</td></tr>
<tr><td>8</td><td>Rendement BACT</td><td>Y_bact</td><td>RIVE</td></tr>
<tr><td>9</td><td>Mortalit√© BACT</td><td>mort_bact</td><td>RIVE</td></tr>
<tr><td>10</td><td>T¬∞ optimale BACT</td><td>Topt_bact</td><td>RIVE</td></tr>
<tr><td>11</td><td>Coeff r√©a√©ration navigation</td><td>K_navig</td><td>TTC</td></tr>
<tr><td>12</td><td>D√©gradabilit√© MO rivi√®re (B1)</td><td>B1_river</td><td>RIVE</td></tr>
</table>

<!-- ============================================================ -->
<h2>5. Carte des entr√©es / sorties</h2>
<!-- ============================================================ -->

<div class="diagram-container">
<pre class="mermaid">
graph LR
    subgraph IN["ENTR√âES"]
        direction TB
        I1["üìÑ Fichier de commande<br/><i>structure du r√©seau, biefs,<br/>singularit√©s, apports, params</i>"]
        I2["üìÑ S√©ries temporelles CL<br/><i>Q(t), Z(t), C(t) aux limites</i>"]
        I3["üìÑ Donn√©es SAFRAN<br/><i>T_air, humidit√©, vent,<br/>rayonnement, pr√©cipitations</i>"]
        I4["üìÑ Observations O‚ÇÇ HF<br/><i>pour assimilation uniquement</i>"]
        I5["üìÑ √âtat initial / reprise<br/><i>concentrations, T¬∞ initiales</i>"]
    end

    subgraph PROSE["PROSE-PA"]
        P1(("Simulation"))
    end

    subgraph OUT["SORTIES"]
        direction TB
        O1["üíß Hydraulique<br/><i>Q(x,t), H(x,t), V(x,t)<br/>par bief et par PK</i>"]
        O2["üß¨ Biog√©ochimie<br/><i>C(x,t) pour 20+ variables :<br/>PHY, ZOO, BACT, O‚ÇÇ, NH‚ÇÑ,<br/>NO‚ÇÉ, PO‚ÇÑ, MOD, MOP, etc.</i>"]
        O3["üå°Ô∏è Temp√©rature<br/><i>T(x,t) + flux SEB d√©taill√©s</i>"]
        O4["‚öñÔ∏è Bilans de masse<br/><i>par esp√®ce, par section,<br/>par domaine, par couche<br/>(eau / vase / p√©riphyton)</i>"]
        O5["üìä Assimilation<br/><i>poids particules w(t)<br/>param√®tres estim√©s Œ∏(t)<br/>Neff(t), taille r√©√©chantillon.</i>"]
        O6["üö¢ Tubes de courant<br/><i>maillage, hydro navigation</i>"]
        O7["üìã Debug / Log<br/><i>traces compl√®tes d'ex√©cution</i>"]
    end

    I1 --> P1
    I2 --> P1
    I3 --> P1
    I4 --> P1
    I5 --> P1
    P1 --> O1
    P1 --> O2
    P1 --> O3
    P1 --> O4
    P1 --> O5
    P1 --> O6
    P1 --> O7

    style IN fill:#e3f2fd,stroke:#64b5f6
    style OUT fill:#e8f5e9,stroke:#66bb6a
    style PROSE fill:#ffeaa7,stroke:#fdcb6e
</pre>
</div>

<!-- ============================================================ -->
<h2>6. Esp√®ces simul√©es par le mod√®le RIVE</h2>
<!-- ============================================================ -->

<div class="diagram-container">
<pre class="mermaid">
graph TD
    subgraph PART["PARTICULAIRES (7)"]
        PHY["üåø PHY<br/>Phytoplancton<br/><i>+ annexes : PHYF, PHYS, PHYR</i>"]
        ZOO["ü¶† ZOO<br/>Zooplancton"]
        BACT["üî¨ BACT<br/>Bact√©ries h√©t√©rotrophes"]
        BACTN["üî¨ BACTN<br/>Bact√©ries nitrifiantes"]
        BIF["ü™∏ BIF<br/>Biofilm / p√©riphyton"]
        MES["ÔøΩite MES<br/>Mati√®res en suspension"]
        MOP["üü§ MOP<br/>Mati√®re organique<br/>particulaire"]
    end

    subgraph DISS["DISSOUS (13)"]
        MOD["MOD<br/>MO dissoute"]
        SODA["SODA<br/>MO dissoute annexe"]
        SID["Si_D<br/>Silice dissoute"]
        NH4["NH‚ÇÑ‚Å∫"]
        NO2["NO‚ÇÇ‚Åª"]
        NO3["NO‚ÇÉ‚Åª"]
        PO4["PO‚ÇÑ¬≥‚Åª"]
        TA_["TA<br/>Alcalinit√© totale"]
        DIC_["DIC<br/>Carbone inorg. dissous"]
        PH_["pH"]
        O2_["O‚ÇÇ dissous"]
        N2O_["N‚ÇÇO"]
        CO2_["CO‚ÇÇ"]
    end

    subgraph LAYERS["3 COUCHES"]
        W["üíß Colonne d'eau<br/>(WATER)"]
        V["üü´ Vase / s√©diments<br/>(VASE)"]
        P["ü™® P√©riphyton<br/>(PERIPHYTON)"]
    end

    W --- PART
    W --- DISS
    V --- MOP
    V --- BACT
    P --- BIF

    style PART fill:#e8f5e9,stroke:#66bb6a
    style DISS fill:#e3f2fd,stroke:#64b5f6
    style LAYERS fill:#ffeaa7,stroke:#fdcb6e
</pre>
</div>

<p style="margin-top:2rem; font-size:0.82rem; color:#636e72; text-align:center;">
    ProSe-PA v0.78 ‚Äî Diagrammes g√©n√©r√©s √† partir de l'analyse du code source (main_PROSE.c, input.y, param_PROSE.h, struct_simul_PROSE.h)
</p>

<script>mermaid.initialize({startOnLoad:true, theme:'neutral', flowchart:{useMaxWidth:true, htmlLabels:true}});</script>
</body>
</html>
